<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãŠã¿ãã˜</title>
  <style>
    /* å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    body {
      font-family: "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      background: #1a1a1a;
      color: #fff;
      text-align: center;
      margin: 0;
      padding: 20px;
    }

    h1 {
      font-size: 28px;
      color: #ffb400;
      text-shadow: 0 0 10px rgba(255,180,0,0.5);
    }

    /* å‹•ç”»ã‚³ãƒ³ãƒ†ãƒŠ */
    .video-container {
      width: 100%;
      max-width: 640px;
      margin: 20px auto;
      aspect-ratio: 16 / 9;
      background: #000;
      border: 3px solid #ff6f61;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ */
    #result-label {
      font-size: 24px;
      font-weight: bold;
      margin: 20px 0;
      min-height: 1.5em;
      color: #ff6f61;
    }

    /* ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
    #action-area {
      min-height: 60px;
    }

    .btn {
      font-size: 18px;
      padding: 15px 35px;
      border: none;
      border-radius: 50px;
      color: #fff;
      cursor: pointer;
      font-weight: bold;
      transition: 0.3s;
      margin: 0 auto 10px auto;
    }

    /* å¼•ããƒœã‚¿ãƒ³ */
    #draw-btn {
      background-color: #ff6f61;
      box-shadow: 0 4px 15px rgba(255, 111, 97, 0.4);
    }
    #draw-btn:hover { background-color: #ff4f40; }
    #draw-btn:disabled { background-color: #555; cursor: not-allowed; opacity: 0.7; }

    /* ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
    #back-btn {
      background-color: #3498db;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
      display: none; /* æœ€åˆã¯éè¡¨ç¤º */
    }
    #back-btn:hover { background-color: #2980b9; }

    /* åœ¨åº«ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ */
    #reset-btn {
      background-color: #444;
      display: none; /* æœ€åˆã¯éè¡¨ç¤º */
    }
    #reset-btn:hover { background-color: #666; }

    /* åœ¨åº«æƒ…å ± */
    .info-area {
      margin-top: 30px;
      font-size: 14px;
      color: #888;
      border-top: 1px solid #333;
      padding-top: 20px;
    }
  </style>
</head>
<body>

  <h1>ğŸ”® ãŠã¿ãã˜ ğŸ”®</h1>
  
  <div class="video-container">
    <video id="omikuji-video" playsinline muted autoplay loop>
      <source id="video-source" src="./waiting.mp4" type="video/mp4">
      ãƒ–ãƒ©ã‚¦ã‚¶ãŒå‹•ç”»å†ç”Ÿã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
    </video>
  </div>

  <div id="result-label">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­</div>

  <div id="action-area">
    <button id="draw-btn" class="btn" onclick="drawOmikuji()">ãŠã¿ãã˜ã‚’å¼•ãï¼</button>
    <button id="back-btn" class="btn" onclick="backToTop()">ãƒˆãƒƒãƒ—ç”»é¢ã«æˆ»ã‚‹</button>
    <button id="reset-btn" class="btn" onclick="resetInventory()">åœ¨åº«ã‚’è£œå……ã™ã‚‹ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰</button>
  </div>

  <div class="info-area">
    <div id="stock-info">æ®‹ã‚Šåˆè¨ˆ: --- å£</div>
    <div id="stock-detail" style="font-size: 12px; margin-top:10px;"></div>
  </div>

  <script>
    // --- 1. å®šæ•°ãƒ»åˆæœŸè¨­å®š ---
    const STORAGE_KEY = 'omikuji_v4_data';
    const initialInventory = {
      "å¤§å‰": { count: 10,  src: "./daikichi.mp4" },
      "å‰":   { count: 20,  src: "./kichi.mp4" },
      "ä¸­å‰": { count: 100, src: "./chukichi.mp4" },
      "å°å‰": { count: 1000,src: "./shokichi.mp4" }
    };

    // --- 2. ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ ---
    let inventory = JSON.parse(localStorage.getItem(STORAGE_KEY)) || JSON.parse(JSON.stringify(initialInventory));

    // HTMLè¦ç´ ã®å–å¾—
    const video = document.getElementById('omikuji-video');
    const drawBtn = document.getElementById('draw-btn');
    const backBtn = document.getElementById('back-btn');
    const resetBtn = document.getElementById('reset-btn');
    const resultLabel = document.getElementById('result-label');
    const stockInfo = document.getElementById('stock-info');
    const stockDetail = document.getElementById('stock-detail');

    // --- 3. UIæ›´æ–°é–¢æ•° ---
    function updateUI() {
      const counts = Object.values(inventory).map(d => d.count);
      const total = counts.reduce((a, b) => a + b, 0);
      
      stockInfo.textContent = `æ®‹ã‚Šåˆè¨ˆ: ${total} å£`;
      
      let detailText = "";
      for (const [name, data] of Object.entries(inventory)) {
        detailText += `${name}:${data.count}  `;
      }
      stockDetail.textContent = detailText;

      // åœ¨åº«åˆ‡ã‚Œã®æ™‚ã®åˆ¤å®š
      if (total === 0) {
        drawBtn.style.display = 'none';
        backBtn.style.display = 'none';
        resetBtn.style.display = 'inline-block';
        resultLabel.textContent = "å®Œå£²ã—ã¾ã—ãŸ";
      }
    }

    // --- 4. ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹é–¢æ•° ---
    function backToTop() {
      // è¡¨ç¤ºã®ãƒªã‚»ãƒƒãƒˆ
      resultLabel.textContent = "ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­";
      backBtn.style.display = 'none';
      drawBtn.style.display = 'inline-block';
      drawBtn.disabled = false;

      // å‹•ç”»ã‚’å¾…æ©Ÿç”¨ã«æˆ»ã™ï¼ˆãƒ«ãƒ¼ãƒ—ãƒ»ãƒŸãƒ¥ãƒ¼ãƒˆã‚ã‚Šï¼‰
      video.loop = true;
      video.muted = true;
      video.src = "./waiting.mp4";
      video.load();
      video.play().catch(e => console.error("å†ç”Ÿå¤±æ•—:", e));
      
      updateUI();
    }

    // --- 5. æŠ½é¸é–¢æ•° ---
    async function drawOmikuji() {
      drawBtn.disabled = true;
      resultLabel.textContent = "æŠ½é¸ä¸­...";

      let box = [];
      for (const [name, data] of Object.entries(inventory)) {
        for (let i = 0; i < data.count; i++) {
          box.push(name);
        }
      }

      if (box.length === 0) return;

      const resultName = box[Math.floor(Math.random() * box.length)];
      const resultData = inventory[resultName];

      // åœ¨åº«æ›´æ–°ã¨ä¿å­˜
      inventory[resultName].count--;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(inventory));

      // å‹•ç”»ã®åˆ‡ã‚Šæ›¿ãˆï¼ˆéŸ³ã‚’å‡ºã™ãŸã‚ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤ã€ãƒ«ãƒ¼ãƒ—è§£é™¤ï¼‰
      video.loop = false;
      video.muted = false;
      video.src = resultData.src;
      video.load();
      
      try {
        await video.play();
        
        // å‹•ç”»å†ç”ŸãŒçµ‚ã‚ã£ãŸæ™‚ã®å‡¦ç†
        video.onended = () => {
          resultLabel.textContent = `çµæœï¼š${resultName}ï¼`;
          
          // åœ¨åº«ãŒæ®‹ã£ã¦ã„ã‚Œã°ã€Œæˆ»ã‚‹ã€ã‚’è¡¨ç¤ºã€ãªã‘ã‚Œã°ã€Œãƒªã‚»ãƒƒãƒˆã€ã‚’è¡¨ç¤º
          const total = Object.values(inventory).reduce((a, b) => a + b.count, 0);
          drawBtn.style.display = 'none';
          
          if (total > 0) {
            backBtn.style.display = 'inline-block';
          }
          updateUI();
        };
      } catch (err) {
        console.error("å†ç”Ÿã‚¨ãƒ©ãƒ¼:", err);
        resultLabel.textContent = `çµæœï¼š${resultName} (å†ç”Ÿã‚¨ãƒ©ãƒ¼)`;
        drawBtn.disabled = false;
        updateUI();
      }
    }

    // --- 6. ãƒªã‚»ãƒƒãƒˆé–¢æ•° ---
    function resetInventory() {
      if (confirm("ãŠã¿ãã˜ã‚’åˆæœŸçŠ¶æ…‹ï¼ˆå…¨1130å£ï¼‰ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      }
    }

    // åˆå›è¡¨ç¤ºã®å®Ÿè¡Œ
    updateUI();
  </script>

</body>
</html>